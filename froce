--[[ 
    FAST FORGE MOBILE V2 - FIX FOR DELTA/ANDROID 
]]

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

print("--- STARTING SCRIPT ---")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui", 10)

if not PlayerGui then 
    warn("Could not find PlayerGui") 
    return 
end

--// CONFIGURATION
local SCROLL_TIER_TARGET = 5 -- Dark Scroll Tier
local SCROLL_NAME_DISPLAY = "Dark Scroll"

--// WAIT FOR KNIT (CRITICAL FIX)
print("Waiting for Knit...")
local Packages = ReplicatedStorage:WaitForChild("Packages", 10)
if not Packages then warn("Packages not found!") return end

local KnitModule = Packages:WaitForChild("Knit", 10)
if not KnitModule then warn("Knit module not found!") return end

local Knit = require(KnitModule)
print("Knit Loaded.")

-- Start Knit if needed (Safety check)
if not Knit.Services then
    pcall(function() Knit.Start() end)
end

--// GET SERVICES
local ForgeService = Knit.GetService("ForgeService")
local ReplicaListener = Knit.GetController("ReplicaListener")

-- Wait for Replica
local PlayerReplica = nil
local StartTime = tick()

print("Waiting for Data Replica...")
repeat 
    PlayerReplica = ReplicaListener:GetReplica()
    task.wait(0.5)
until PlayerReplica or (tick() - StartTime > 20)

if not PlayerReplica then
    warn("Failed to load Player Data. Try rejoining.")
    return
end
print("Data Loaded!")

local AccessoryInfo = require(ReplicatedStorage:WaitForChild("GameInfo"):WaitForChild("AccessoryInfo"))

--// UI SETUP (MOBILE FRIENDLY)
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "FastForgeMobile"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = PlayerGui

-- TOGGLE BUTTON (วงกลมเล็กๆ มุมจอ)
local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Name = "Toggle"
ToggleBtn.Size = UDim2.new(0, 50, 0, 50)
ToggleBtn.Position = UDim2.new(0.85, 0, 0.2, 0) -- มุมขวาบน
ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
ToggleBtn.Text = "UI"
ToggleBtn.TextColor3 = Color3.new(1,1,1)
ToggleBtn.Font = Enum.Font.GothamBold
ToggleBtn.TextSize = 18
ToggleBtn.Parent = ScreenGui
Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(1, 0)

-- MAIN FRAME
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 350, 0, 300) -- เล็กลงเพื่อให้พอดีจอมือถือ
MainFrame.Position = UDim2.new(0.5, -175, 0.5, -150)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
MainFrame.Visible = false -- เริ่มต้นซ่อนไว้
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = MainFrame

-- Dragging Logic for Mobile
local dragging, dragInput, dragStart, startPos
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

MainFrame.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- Toggle Function
ToggleBtn.MouseButton1Click:Connect(function()
    MainFrame.Visible = not MainFrame.Visible
end)

-- Title
local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(1, -20, 0, 30)
TitleLabel.Position = UDim2.new(0, 10, 0, 5)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "Forge: Dark Scroll (T5)"
TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.TextSize = 14
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.Parent = MainFrame

-- Scroll Counter
local ScrollCounter = Instance.new("TextLabel")
ScrollCounter.Size = UDim2.new(0, 100, 0, 30)
ScrollCounter.Position = UDim2.new(1, -110, 0, 5)
ScrollCounter.BackgroundTransparency = 1
ScrollCounter.Text = "Waiting..."
ScrollCounter.TextColor3 = Color3.fromRGB(100, 255, 100)
ScrollCounter.Font = Enum.Font.GothamBold
ScrollCounter.TextSize = 14
ScrollCounter.TextXAlignment = Enum.TextXAlignment.Right
ScrollCounter.Parent = MainFrame

-- Grid Container
local ScrollContainer = Instance.new("ScrollingFrame")
ScrollContainer.Size = UDim2.new(1, -10, 1, -50)
ScrollContainer.Position = UDim2.new(0, 5, 0, 40)
ScrollContainer.BackgroundTransparency = 1
ScrollContainer.ScrollBarThickness = 4
ScrollContainer.Parent = MainFrame

local UIGridLayout = Instance.new("UIGridLayout")
UIGridLayout.CellSize = UDim2.new(0, 100, 0, 130) -- ปรับขนาดการ์ดให้เล็กลง
UIGridLayout.CellPadding = UDim2.new(0, 5, 0, 5)
UIGridLayout.Parent = ScrollContainer

--// LOGIC
local AutoForgeTargetGUID = nil
local IsForging = false

local function GetScrollAmount()
    if PlayerReplica and PlayerReplica.Data then
        local inv = PlayerReplica.Data.ItemsService.Inventory
        if inv and inv.Scrolls and inv.Scrolls[tostring(SCROLL_TIER_TARGET)] then
            return inv.Scrolls[tostring(SCROLL_TIER_TARGET)]
        end
    end
    return 0
end

local function GetAccessoryImage(name)
    local info = AccessoryInfo[name]
    if info and info.Image then
        return "rbxassetid://" .. info.Image
    end
    return ""
end

-- Refresh UI Function
local function RefreshInventory()
    print("Refreshing Inventory UI...")
    for _, child in pairs(ScrollContainer:GetChildren()) do
        if child:IsA("Frame") then child:Destroy() end
    end

    if not PlayerReplica or not PlayerReplica.Data then return end
    local accessories = PlayerReplica.Data.AccessoryService.Accessories
    
    for guid, itemData in pairs(accessories) do
        if type(itemData) == "table" and itemData.Name then
            local staticInfo = AccessoryInfo[itemData.Name]
            if staticInfo then
                local Card = Instance.new("Frame")
                Card.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
                Card.Parent = ScrollContainer
                Instance.new("UICorner", Card).CornerRadius = UDim.new(0, 6)
                
                -- Image
                local Img = Instance.new("ImageLabel")
                Img.Size = UDim2.new(0, 60, 0, 60)
                Img.Position = UDim2.new(0.5, -30, 0, 5)
                Img.BackgroundTransparency = 1
                Img.Image = GetAccessoryImage(itemData.Name)
                Img.Parent = Card
                
                -- Name
                local NameLbl = Instance.new("TextLabel")
                NameLbl.Size = UDim2.new(1, 0, 0, 20)
                NameLbl.Position = UDim2.new(0, 0, 0, 65)
                NameLbl.BackgroundTransparency = 1
                NameLbl.Text = itemData.Nickname or itemData.Name
                NameLbl.TextColor3 = Color3.fromRGB(255, 255, 255)
                NameLbl.Font = Enum.Font.GothamBold
                NameLbl.TextSize = 10
                NameLbl.TextWrapped = true
                NameLbl.Parent = Card
                
                -- Status
                local StatusLbl = Instance.new("TextLabel")
                StatusLbl.Size = UDim2.new(1, 0, 0, 15)
                StatusLbl.Position = UDim2.new(0, 0, 0, 85)
                StatusLbl.BackgroundTransparency = 1
                StatusLbl.TextColor3 = Color3.fromRGB(150, 150, 255)
                StatusLbl.TextSize = 9
                if itemData.Scroll then
                    StatusLbl.Text = "Tier " .. itemData.Scroll.Tier
                else
                    StatusLbl.Text = "No Scroll"
                end
                StatusLbl.Parent = Card
                
                -- Button
                local Btn = Instance.new("TextButton")
                Btn.Size = UDim2.new(0.9, 0, 0, 20)
                Btn.Position = UDim2.new(0.05, 0, 1, -25)
                Btn.BackgroundColor3 = Color3.fromRGB(45, 45, 60)
                Btn.Text = "Auto"
                Btn.TextColor3 = Color3.fromRGB(255, 255, 255)
                Btn.Font = Enum.Font.GothamBold
                Btn.TextSize = 11
                Btn.Parent = Card
                Instance.new("UICorner", Btn).CornerRadius = UDim.new(0, 4)
                
                Btn.MouseButton1Click:Connect(function()
                     if AutoForgeTargetGUID == guid and IsForging then
                        IsForging = false
                        AutoForgeTargetGUID = nil
                        Btn.Text = "Auto"
                        Btn.BackgroundColor3 = Color3.fromRGB(45, 45, 60)
                    else
                        -- Reset others
                        for _, c in pairs(ScrollContainer:GetChildren()) do
                            if c:IsA("Frame") then
                                c.TextButton.Text = "Auto"
                                c.TextButton.BackgroundColor3 = Color3.fromRGB(45, 45, 60)
                            end
                        end
                        AutoForgeTargetGUID = guid
                        IsForging = true
                        Btn.Text = "STOP"
                        Btn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
                    end
                end)
            end
        end
    end
end

--// AUTO FORGE LOOP
task.spawn(function()
    while true do
        task.wait(0.25)
        if IsForging and AutoForgeTargetGUID then
            local scrolls = GetScrollAmount()
            if scrolls > 0 then
                ScrollCounter.Text = "x" .. scrolls
                local success, err = pcall(function()
                    ForgeService.RF.Forge:InvokeServer(AutoForgeTargetGUID, SCROLL_TIER_TARGET)
                end)
            else
                IsForging = false
                ScrollCounter.Text = "Empty"
            end
        else
            ScrollCounter.Text = "x" .. GetScrollAmount()
        end
    end
end)

-- Initial Load
RefreshInventory()
MainFrame.Visible = true -- Show initially
print("UI Loaded successfully!")
